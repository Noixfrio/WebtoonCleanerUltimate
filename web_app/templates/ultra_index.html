<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA IA - Standalone v1.0</title>
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --primary: #8b5cf6;
            --text: #f8fafc;
        }

        body {
            margin: 0;
            font-family: system-ui;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            padding: 10px 20px;
            background: var(--surface);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #334155;
        }

        .toolbar {
            padding: 10px;
            background: var(--surface);
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            cursor: crosshair;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        #canvas-fg {
            pointer-events: auto;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            background: #334155;
            color: white;
            transition: 0.2s;
        }

        button:hover {
            filter: brightness(1.2);
        }

        button.primary {
            background: var(--primary);
        }

        .dropzone {
            position: absolute;
            inset: 20px;
            border: 2px dashed #334155;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h3 style="margin:0">ULTRA IA STANDALONE</h3>
        <div id="status">Aguardando imagem...</div>
    </div>

    <div class="toolbar" id="toolbar" style="display:none">
        <button onclick="goBack()" style="background:#ef4444;" title="Atalho: Tecla ESC">ðŸ”™ Sair / Voltar</button>
        <button onclick="clearMask()">ðŸ§¹ Limpar</button>
        <div style="display:flex; align-items:center; gap:8px">
            <label>Pincel:</label>
            <input type="range" id="brushSize" min="5" max="150" value="40">
        </div>
        <button class="primary" id="btnRun" onclick="process()">ðŸš€ PROCESSAR IA (CALIBRADO)</button>
        <button onclick="download()">ðŸ’¾ BAIXAR</button>
    </div>

    <div class="canvas-container" id="editor">
        <div class="dropzone" id="dropzone">
            <h2>Arraste uma imagem ou clique para abrir</h2>
            <input type="file" id="fileInput" hidden accept="image/*">
            <button class="primary" onclick="document.getElementById('fileInput').click()">Abrir Arquivo</button>
        </div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        let bgCanvas, fgCanvas, bCtx, fCtx;
        let isDrawing = false;
        let imageLoaded = false;

        fileInput.onchange = (e) => loadFile(e.target.files[0]);
        dropzone.ondragover = (e) => e.preventDefault();
        dropzone.ondrop = (e) => { e.preventDefault(); loadFile(e.dataTransfer.files[0]); };

        window.onload = () => {
            if (window.opener) {
                window.opener.postMessage("ULTRA_READY", "http://localhost:5000");
            }
        };

        window.addEventListener("message", (event) => {
            if (event.origin !== "http://localhost:5000") return;
            if (event.data && event.data.type === "LOAD_IMAGE") {
                const img = new Image();
                img.onload = () => setupEditor(img);
                img.src = event.data.base64;
            }
        });

        function loadFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => setupEditor(img);
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function setupEditor(img) {
            dropzone.style.display = 'none';
            document.getElementById('toolbar').style.display = 'flex';
            imageLoaded = true;

            bgCanvas = document.createElement('canvas');
            fgCanvas = document.createElement('canvas');
            bgCanvas.width = fgCanvas.width = img.width;
            bgCanvas.height = fgCanvas.height = img.height;

            bCtx = bgCanvas.getContext('2d');
            fCtx = fgCanvas.getContext('2d');

            bCtx.drawImage(img, 0, 0);

            fgCanvas.id = "canvas-fg";
            editor.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.style.width = img.width + 'px';
            wrapper.style.height = img.height + 'px';
            wrapper.appendChild(bgCanvas);
            wrapper.appendChild(fgCanvas);
            editor.appendChild(wrapper);

            attachEvents();
            document.getElementById('status').innerText = "Pronto. Pinte a Ã¡rea e processe.";
        }

        function attachEvents() {
            fgCanvas.onmousedown = (e) => { isDrawing = true; draw(e); };
            fgCanvas.onmousemove = draw;
            window.onmouseup = () => isDrawing = false;

            // Atalho Esc para Voltar
            window.onkeydown = (e) => {
                if (e.key === "Escape") goBack();
            };
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = fgCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (fgCanvas.width / rect.width);
            const y = (e.clientY - rect.top) * (fgCanvas.height / rect.height);

            fCtx.fillStyle = 'rgba(139, 92, 246, 0.6)';
            fCtx.beginPath();
            fCtx.arc(x, y, document.getElementById('brushSize').value / 2, 0, Math.PI * 2);
            fCtx.fill();
        }

        function clearMask() {
            if (!fCtx) return;
            fCtx.clearRect(0, 0, fgCanvas.width, fgCanvas.height);
        }

        async function process() {
            if (!imageLoaded) return;
            const btn = document.getElementById('btnRun');
            document.getElementById('status').innerText = "Processando na Porta 5001...";
            btn.disabled = true;

            const res = await fetch('/api/ultra_inpaint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image: bgCanvas.toDataURL('image/png'),
                    mask: fgCanvas.toDataURL('image/png'),
                    use_frequency_separation: true
                })
            });

            const data = await res.json();
            if (data.result) {
                const img = new Image();
                img.onload = () => {
                    bCtx.drawImage(img, 0, 0);
                    clearMask();
                    document.getElementById('status').innerText = "ConcluÃ­do!";
                    btn.disabled = false;

                    if (window.opener) {
                        try {
                            window.opener.postMessage({ type: "ULTRA_RESULT", base64: bgCanvas.toDataURL("image/png") }, "http://localhost:5000");
                            document.getElementById('status').innerText = "Salvo de volta no Editor Principal!";
                        } catch (e) {
                            console.error(e);
                        }
                    }
                };
                img.src = data.result;
            } else {
                alert("Erro!");
                btn.disabled = false;
            }
        }

        function download() {
            const link = document.createElement('a');
            link.download = 'ultra_result.png';
            link.href = bgCanvas.toDataURL();
            link.click();
        }

        function goBack() {
            if (window.opener) {
                window.close();
            } else {
                window.location.href = "http://localhost:5000";
            }
        }
    </script>
</body>

</html>